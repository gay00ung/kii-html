<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì–¼êµ´ì¸ì‹ í†µí•© ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1600px; margin: 0 auto; }
        
        .header {
            text-align: center;
            color: white;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        
        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            margin: 20px 0;
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .file-input-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        /* í†µí•© ë¶„ì„ ê²°ê³¼ ì„¹ì…˜ */
        .analysis-summary {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 1em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-detail {
            font-size: 0.9em;
            color: #888;
        }
        
        .success { color: #4caf50; }
        .fail { color: #f44336; }
        
        /* ì°¨íŠ¸ ì„¹ì…˜ */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .chart-container {
            position: relative;
            height: 400px;
        }
        
        /* ì›ë˜ ëŒ€ì‹œë³´ë“œ ìŠ¤íƒ€ì¼ */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h2 {
            color: #2a5298;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        
        .full-width-card {
            grid-column: 1 / -1;
        }
        
        /* ìµœì  ì¡°ê±´ í…Œì´ë¸” */
        .optimal-conditions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .optimal-conditions table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .optimal-conditions th, .optimal-conditions td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .optimal-conditions th {
            background: #e3f2fd;
            font-weight: bold;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ ì–¼êµ´ì¸ì‹ í†µí•© ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
            <p>Liveness, Matching, Sensor ë°ì´í„°ë¥¼ í†µí•© ë¶„ì„í•©ë‹ˆë‹¤</p>
        </div>
        
        <div class="upload-section">
            <h2>CSV íŒŒì¼ ì—…ë¡œë“œ</h2>
            <p>í•˜ë‚˜ ë˜ëŠ” ì—¬ëŸ¬ ê°œì˜ CSV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
            <div class="file-input-wrapper">
                <input type="file" id="csvFile" accept=".csv" multiple>
                <div class="file-input-button">ğŸ“ íŒŒì¼ ì„ íƒ (ì—¬ëŸ¬ ê°œ ê°€ëŠ¥)</div>
            </div>
            <div id="fileList" style="margin: 20px 0; text-align: left;"></div>
            <button id="analyzeButton" style="display: none; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; padding: 12px 30px; border: none; border-radius: 50px; font-size: 1em; font-weight: bold; cursor: pointer; margin-top: 10px;">
                ğŸ“Š ë¶„ì„ ì‹œì‘
            </button>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ë°ì´í„° ë¶„ì„ ì¤‘...</p>
            </div>
        </div>
        
        <!-- í†µí•© ë¶„ì„ ìš”ì•½ -->
        <div class="analysis-summary" id="analysisSummary">
            <h2>ğŸ“Š ì „ì²´ í†µê³„</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">ì „ì²´ ì‹œë„ íšŸìˆ˜</div>
                    <div class="stat-value" id="totalAttempts">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Liveness ì„±ê³µë¥ </div>
                    <div class="stat-value" id="livenessRate">-%</div>
                    <div class="stat-detail">
                        <span class="success">ì„±ê³µ: <span id="livenessSuccess">0</span></span> | 
                        <span class="fail">ì‹¤íŒ¨: <span id="livenessFail">0</span></span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Matching ì„±ê³µë¥ </div>
                    <div class="stat-value" id="matchingRate">-%</div>
                    <div class="stat-detail">
                        <span class="success">ì„±ê³µ: <span id="matchingSuccess">0</span></span> | 
                        <span class="fail">ì‹¤íŒ¨: <span id="matchingFail">0</span></span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ì™„ì „ ì„±ê³µë¥ </div>
                    <div class="stat-value" id="completeRate">-%</div>
                    <div class="stat-detail">Liveness & Matching ëª¨ë‘ ì„±ê³µ</div>
                </div>
            </div>
            
            <!-- ìµœì  ì¡°ê±´ ë¶„ì„ -->
            <div class="optimal-conditions" id="optimalConditions">
                <h3>âœ¨ ìµœì  ì¸ì¦ ì¡°ê±´</h3>
                <table>
                    <tr>
                        <th>ì¡°ê±´</th>
                        <th>ê¶Œì¥ ë²”ìœ„</th>
                        <th>í˜„ì¬ ìƒíƒœ</th>
                    </tr>
                    <tr>
                        <td>ì¡°ë„</td>
                        <td id="optimalLight">-</td>
                        <td id="currentLight">-</td>
                    </tr>
                    <tr>
                        <td>Pitch (ìƒí•˜)</td>
                        <td id="optimalPitch">-</td>
                        <td id="currentPitch">-</td>
                    </tr>
                    <tr>
                        <td>Yaw (ì¢Œìš°)</td>
                        <td id="optimalYaw">-</td>
                        <td id="currentYaw">-</td>
                    </tr>
                    <tr>
                        <td>Roll (ê¸°ìš¸ì„)</td>
                        <td id="optimalRoll">-</td>
                        <td id="currentRoll">-</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
        <div class="charts-section" id="chartsSection" style="display: none;">
            <div class="chart-card">
                <h2>ğŸ“Š ì¡°ëª…ë³„ ì„±ê³µë¥ </h2>
                <div class="chart-container">
                    <canvas id="lightSuccessChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h2>ğŸ¯ ì–¼êµ´ ë°©í–¥ ë¶„í¬ (ì„±ê³µ vs ì‹¤íŒ¨)</h2>
                <div class="chart-container">
                    <canvas id="orientationScatterChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h2>ğŸ“ˆ ë§¤ì¹­ ì ìˆ˜ ë¶„í¬</h2>
                <div class="chart-container">
                    <canvas id="matchingScoreChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h2>ğŸ”¥ ì„¼ì„œ ë°ì´í„° ìƒê´€ê´€ê³„</h2>
                <div class="chart-container">
                    <canvas id="correlationChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- ê¸°ì¡´ ì„¼ì„œ ë¶„ì„ ëŒ€ì‹œë³´ë“œ -->
        <div class="dashboard" id="dashboard" style="display: none;">
            <!-- ê¸°ì¡´ ì¹´ë“œë“¤ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ -->
        </div>
    </div>
    
    <script>
        let analysisData = {
            liveness: [],
            matching: [],
            sensor: [],
            merged: []
        };
        
        let selectedFiles = [];
        let combinedData = {
            liveness: [],
            matching: [],
            sensor: []
        };
        
        // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
        document.getElementById('csvFile').addEventListener('change', function(e) {
            selectedFiles = Array.from(e.target.files);
            displayFileList();
        });
        
        // ì„ íƒëœ íŒŒì¼ ëª©ë¡ í‘œì‹œ
        function displayFileList() {
            const fileListDiv = document.getElementById('fileList');
            const analyzeButton = document.getElementById('analyzeButton');
            
            if (selectedFiles.length === 0) {
                fileListDiv.innerHTML = '';
                analyzeButton.style.display = 'none';
                return;
            }
            
            let html = '<h3>ì„ íƒëœ íŒŒì¼:</h3><ul style="list-style: none; padding: 0;">';
            selectedFiles.forEach((file, index) => {
                html += `<li style="padding: 5px; background: #f0f0f0; margin: 5px 0; border-radius: 5px;">
                    ğŸ“„ ${file.name} (${(file.size / 1024).toFixed(2)} KB)
                    <button onclick="removeFile(${index})" style="float: right; background: #f44336; color: white; border: none; padding: 2px 10px; border-radius: 3px; cursor: pointer;">âœ•</button>
                </li>`;
            });
            html += '</ul>';
            
            fileListDiv.innerHTML = html;
            analyzeButton.style.display = 'inline-block';
        }
        
        // íŒŒì¼ ì œê±°
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            displayFileList();
        }
        
        // ë¶„ì„ ì‹œì‘ ë²„íŠ¼
        document.getElementById('analyzeButton').addEventListener('click', function() {
            if (selectedFiles.length === 0) {
                alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            document.getElementById('loading').classList.add('active');
            combinedData = { liveness: [], matching: [], sensor: [] };
            
            let processedCount = 0;
            
            // ê° íŒŒì¼ì„ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬
            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    parseIntegratedCSV(e.target.result, file.name);
                    processedCount++;
                    
                    // ëª¨ë“  íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ
                    if (processedCount === selectedFiles.length) {
                        finalizeAnalysis();
                    }
                };
                reader.readAsText(file);
            });
        });
        
        function parseIntegratedCSV(content, fileName) {
            const lines = content.split('\n');
            
            // í˜„ì¬ íŒŒì¼ì˜ ë°ì´í„°
            let currentFileData = {
                liveness: [],
                matching: [],
                sensor: [],
                fileName: fileName
            };
            
            // í…Œì´ë¸” ì„¹ì…˜ ì°¾ê¸°
            let currentSection = null;
            let sectionData = {
                liveness: [],
                matching: [],
                sensor: []
            };
            
            lines.forEach(line => {
                if (line.includes('Table: Liveness History')) {
                    currentSection = 'liveness';
                } else if (line.includes('Table: Matching History')) {
                    currentSection = 'matching';
                } else if (line.includes('Table: Sensor Data')) {
                    currentSection = 'sensor';
                } else if (currentSection && line.trim() && !line.includes('Table:')) {
                    sectionData[currentSection].push(line);
                }
            });
            
            // ê° ì„¹ì…˜ íŒŒì‹±
            Object.keys(sectionData).forEach(type => {
                if (sectionData[type].length > 1) {
                    const headers = parseCSVLine(sectionData[type][0]);
                    
                    for (let i = 1; i < sectionData[type].length; i++) {
                        const values = parseCSVLine(sectionData[type][i]);
                        if (values.length === headers.length) {
                            const row = { _sourceFile: fileName };
                            headers.forEach((header, index) => {
                                row[header] = values[index];
                            });
                            currentFileData[type].push(row);
                            combinedData[type].push(row);
                        }
                    }
                }
            });
            
            console.log(`íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ: ${fileName}`);
            console.log(`- Liveness: ${currentFileData.liveness.length}ê±´`);
            console.log(`- Matching: ${currentFileData.matching.length}ê±´`);
            console.log(`- Sensor: ${currentFileData.sensor.length}ê±´`);
        }
        
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current.trim());
            
            return values.map(v => v.replace(/^"|"$/g, ''));
        }
        
        function finalizeAnalysis() {
            console.log('\n=== ì „ì²´ ë°ì´í„° í†µí•© ì™„ë£Œ ===');
            console.log(`ì´ Liveness ë°ì´í„°: ${combinedData.liveness.length}ê±´`);
            console.log(`ì´ Matching ë°ì´í„°: ${combinedData.matching.length}ê±´`);
            console.log(`ì´ Sensor ë°ì´í„°: ${combinedData.sensor.length}ê±´`);
            
            // analysisDataì— í†µí•© ë°ì´í„° í• ë‹¹
            analysisData.liveness = combinedData.liveness;
            analysisData.matching = combinedData.matching;
            analysisData.sensor = combinedData.sensor;
            
            // ë°ì´í„° ë³‘í•© ë° ë¶„ì„
            mergeAndAnalyze();
            
            // íŒŒì¼ë³„ í†µê³„ ì¶”ê°€
            displayFileStatistics();
            
            document.getElementById('loading').classList.remove('active');
            document.getElementById('analysisSummary').style.display = 'block';
            document.getElementById('chartsSection').style.display = 'grid';
        }
        
        function displayFileStatistics() {
            // íŒŒì¼ë³„ í†µê³„ ê³„ì‚°
            const fileStats = {};
            
            selectedFiles.forEach(file => {
                const fileName = file.name;
                fileStats[fileName] = {
                    liveness: combinedData.liveness.filter(d => d._sourceFile === fileName).length,
                    matching: combinedData.matching.filter(d => d._sourceFile === fileName).length,
                    sensor: combinedData.sensor.filter(d => d._sourceFile === fileName).length
                };
            });
            
            // í†µê³„ í‘œì‹œë¥¼ ìœ„í•œ HTML ì¶”ê°€
            const summaryDiv = document.getElementById('analysisSummary');
            let statsHTML = '<div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 20px 0;">';
            statsHTML += '<h3>ğŸ“ íŒŒì¼ë³„ ë°ì´í„° í†µê³„</h3>';
            statsHTML += '<table style="width: 100%; border-collapse: collapse;">';
            statsHTML += '<tr style="background: #e3f2fd;"><th style="padding: 10px; text-align: left;">íŒŒì¼ëª…</th><th style="padding: 10px;">Liveness</th><th style="padding: 10px;">Matching</th><th style="padding: 10px;">Sensor</th></tr>';
            
            Object.entries(fileStats).forEach(([fileName, stats]) => {
                statsHTML += `<tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 10px;">${fileName}</td>
                    <td style="padding: 10px; text-align: center;">${stats.liveness}</td>
                    <td style="padding: 10px; text-align: center;">${stats.matching}</td>
                    <td style="padding: 10px; text-align: center;">${stats.sensor}</td>
                </tr>`;
            });
            
            statsHTML += '</table></div>';
            
            // ê¸°ì¡´ í†µê³„ ë‹¤ìŒì— ì¶”ê°€
            const existingStats = summaryDiv.querySelector('.stats-grid');
            existingStats.insertAdjacentHTML('afterend', statsHTML);
        }
        
        function mergeAndAnalyze() {
            // IDë¡œ ë°ì´í„° ë³‘í•©
            const mergedData = {};
            
            // Liveness ë°ì´í„° ì²˜ë¦¬
            analysisData.liveness.forEach(row => {
                const id = row.ID;
                if (!mergedData[id]) mergedData[id] = { _sourceFiles: [] };
                
                // ì–´ëŠ íŒŒì¼ì—ì„œ ì™”ëŠ”ì§€ ê¸°ë¡
                if (row._sourceFile && !mergedData[id]._sourceFiles.includes(row._sourceFile)) {
                    mergedData[id]._sourceFiles.push(row._sourceFile);
                }
                
                mergedData[id].liveness = {
                    result: parseInt(row.Result) === 1 ? 1 : 0,
                    score: parseFloat(row.Score),
                    sourceFile: row._sourceFile
                };
            });
            
            // Matching ë°ì´í„° ì²˜ë¦¬
            analysisData.matching.forEach(row => {
                const id = row.ID;
                if (!mergedData[id]) mergedData[id] = { _sourceFiles: [] };
                
                if (row._sourceFile && !mergedData[id]._sourceFiles.includes(row._sourceFile)) {
                    mergedData[id]._sourceFiles.push(row._sourceFile);
                }
                
                const result = parseInt(row.Result);
                mergedData[id].matching = {
                    result: result === 1 ? 1 : 0,
                    score: parseFloat(row.Score),
                    threshold: parseFloat(row['Threshold Score']),
                    message: row.Message,
                    sourceFile: row._sourceFile
                };
            });
            
            // Sensor ë°ì´í„° ì²˜ë¦¬
            analysisData.sensor.forEach(row => {
                const id = row.ID;
                if (!mergedData[id]) mergedData[id] = { _sourceFiles: [] };
                
                if (row._sourceFile && !mergedData[id]._sourceFiles.includes(row._sourceFile)) {
                    mergedData[id]._sourceFiles.push(row._sourceFile);
                }
                
                const eulerAngles = row['Euler Angles (X,Y,Z)'].split(',').map(v => parseFloat(v));
                mergedData[id].sensor = {
                    eulerX: eulerAngles[0],
                    eulerY: eulerAngles[1],
                    eulerZ: eulerAngles[2],
                    ambientLight: parseFloat(row['Ambient Light']),
                    sourceFile: row._sourceFile
                };
            });
            
            // ë°°ì—´ë¡œ ë³€í™˜
            analysisData.merged = Object.entries(mergedData).map(([id, data]) => ({
                id,
                ...data
            }));
            
            console.log(`ë³‘í•©ëœ ê³ ìœ  ID ìˆ˜: ${analysisData.merged.length}`);
            
            // í†µê³„ ê³„ì‚° ë° í‘œì‹œ
            calculateStatistics();
            drawCharts();
        }
        
        function calculateStatistics() {
            const total = analysisData.merged.length;
            
            // Liveness í†µê³„
            const livenessSuccess = analysisData.merged.filter(d => d.liveness && d.liveness.result === 1).length;
            const livenessFail = analysisData.merged.filter(d => d.liveness && d.liveness.result === 0).length;
            const livenessRate = (livenessSuccess / (livenessSuccess + livenessFail) * 100) || 0;
            
            // Matching í†µê³„
            const matchingSuccess = analysisData.merged.filter(d => d.matching && d.matching.result === 1).length;
            const matchingFail = analysisData.merged.filter(d => d.matching && d.matching.result === 0).length;
            const matchingRate = (matchingSuccess / (matchingSuccess + matchingFail) * 100) || 0;
            
            // ì™„ì „ ì„±ê³µë¥ 
            const completeSuccess = analysisData.merged.filter(d => 
                d.liveness && d.liveness.result === 1 && 
                d.matching && d.matching.result === 1
            ).length;
            const completeRate = (completeSuccess / total * 100) || 0;
            
            // í™”ë©´ì— í‘œì‹œ
            document.getElementById('totalAttempts').textContent = total;
            document.getElementById('livenessRate').textContent = livenessRate.toFixed(1) + '%';
            document.getElementById('livenessSuccess').textContent = livenessSuccess;
            document.getElementById('livenessFail').textContent = livenessFail;
            document.getElementById('matchingRate').textContent = matchingRate.toFixed(1) + '%';
            document.getElementById('matchingSuccess').textContent = matchingSuccess;
            document.getElementById('matchingFail').textContent = matchingFail;
            document.getElementById('completeRate').textContent = completeRate.toFixed(1) + '%';
            
            // ìµœì  ì¡°ê±´ ê³„ì‚°
            calculateOptimalConditions();
        }
        
        function calculateOptimalConditions() {
            // ì™„ì „ ì„±ê³µ ì¼€ì´ìŠ¤ë§Œ í•„í„°ë§
            const successCases = analysisData.merged.filter(d => 
                d.liveness && d.liveness.result === 1 && 
                d.matching && d.matching.result === 1 &&
                d.sensor
            );
            
            if (successCases.length > 0) {
                // ì¡°ë„ ë²”ìœ„
                const lights = successCases.map(d => d.sensor.ambientLight).sort((a, b) => a - b);
                const lightQ1 = lights[Math.floor(lights.length * 0.25)];
                const lightQ3 = lights[Math.floor(lights.length * 0.75)];
                document.getElementById('optimalLight').textContent = `${lightQ1.toFixed(0)} ~ ${lightQ3.toFixed(0)} lux`;
                
                // ê°ë„ ë²”ìœ„
                const pitches = successCases.map(d => Math.abs(d.sensor.eulerX)).sort((a, b) => a - b);
                const yaws = successCases.map(d => Math.abs(d.sensor.eulerY)).sort((a, b) => a - b);
                const rolls = successCases.map(d => Math.abs(d.sensor.eulerZ)).sort((a, b) => a - b);
                
                document.getElementById('optimalPitch').textContent = `Â±${pitches[Math.floor(pitches.length * 0.75)].toFixed(1)}Â°`;
                document.getElementById('optimalYaw').textContent = `Â±${yaws[Math.floor(yaws.length * 0.75)].toFixed(1)}Â°`;
                document.getElementById('optimalRoll').textContent = `Â±${rolls[Math.floor(rolls.length * 0.75)].toFixed(1)}Â°`;
            }
        }
        
        function drawCharts() {
            // 1. ì¡°ëª…ë³„ ì„±ê³µë¥  ì°¨íŠ¸
            drawLightSuccessChart();
            
            // 2. ì–¼êµ´ ë°©í–¥ ë¶„í¬ ì°¨íŠ¸
            drawOrientationScatterChart();
            
            // 3. ë§¤ì¹­ ì ìˆ˜ ë¶„í¬ ì°¨íŠ¸
            drawMatchingScoreChart();
            
            // 4. ìƒê´€ê´€ê³„ íˆíŠ¸ë§µ
            drawCorrelationChart();
        }
        
        function drawLightSuccessChart() {
            const lightBins = [
                { label: 'ë§¤ìš°ì–´ë‘ì›€', min: 0, max: 50 },
                { label: 'ì–´ë‘ì›€', min: 50, max: 100 },
                { label: 'ë³´í†µ', min: 100, max: 200 },
                { label: 'ë°ìŒ', min: 200, max: 300 },
                { label: 'ë§¤ìš°ë°ìŒ', min: 300, max: 500 }
            ];
            
            const lightData = lightBins.map(bin => {
                const inBin = analysisData.merged.filter(d => 
                    d.sensor && 
                    d.sensor.ambientLight >= bin.min && 
                    d.sensor.ambientLight < bin.max
                );
                
                const livenessSuccess = inBin.filter(d => d.liveness && d.liveness.result === 1).length;
                const matchingSuccess = inBin.filter(d => d.matching && d.matching.result === 1).length;
                
                return {
                    label: bin.label,
                    livenessRate: inBin.length > 0 ? (livenessSuccess / inBin.length * 100) : 0,
                    matchingRate: inBin.length > 0 ? (matchingSuccess / inBin.length * 100) : 0,
                    count: inBin.length
                };
            });
            
            const ctx = document.getElementById('lightSuccessChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: lightData.map(d => d.label),
                    datasets: [
                        {
                            label: 'Liveness',
                            data: lightData.map(d => d.livenessRate),
                            backgroundColor: 'rgba(33, 150, 243, 0.7)',
                            borderColor: '#2196f3',
                            borderWidth: 2
                        },
                        {
                            label: 'Matching',
                            data: lightData.map(d => d.matchingRate),
                            backgroundColor: 'rgba(255, 152, 0, 0.7)',
                            borderColor: '#ff9800',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: value => value + '%' }
                        }
                    }
                }
            });
        }
        
        function drawOrientationScatterChart() {
            const successData = analysisData.merged
                .filter(d => d.sensor && d.liveness && d.matching && 
                        d.liveness.result === 1 && d.matching.result === 1)
                .map(d => ({ x: d.sensor.eulerY, y: d.sensor.eulerX }));
                
            const failData = analysisData.merged
                .filter(d => d.sensor && 
                        ((d.liveness && d.liveness.result === 0) || 
                         (d.matching && d.matching.result === 0)))
                .map(d => ({ x: d.sensor.eulerY, y: d.sensor.eulerX }));
            
            const ctx = document.getElementById('orientationScatterChart').getContext('2d');
            new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'ì„±ê³µ',
                            data: successData,
                            backgroundColor: 'rgba(76, 175, 80, 0.6)',
                            pointRadius: 6
                        },
                        {
                            label: 'ì‹¤íŒ¨',
                            data: failData,
                            backgroundColor: 'rgba(244, 67, 54, 0.6)',
                            pointRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            title: { display: true, text: 'Yaw (ì¢Œìš° íšŒì „)' },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        },
                        y: { 
                            title: { display: true, text: 'Pitch (ìƒí•˜ íšŒì „)' },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' }
                        }
                    }
                }
            });
        }
        
        function drawMatchingScoreChart() {
            const successScores = analysisData.merged
                .filter(d => d.matching && d.matching.result === 1)
                .map(d => d.matching.score);
                
            const failScores = analysisData.merged
                .filter(d => d.matching && d.matching.result === 0)
                .map(d => d.matching.score);
            
            const threshold = analysisData.merged
                .find(d => d.matching && d.matching.threshold)?.matching.threshold || 4100;
            
            const ctx = document.getElementById('matchingScoreChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ì„±ê³µ', 'ì‹¤íŒ¨'],
                    datasets: [{
                        label: 'í‰ê·  ë§¤ì¹­ ì ìˆ˜',
                        data: [
                            successScores.length > 0 ? successScores.reduce((a, b) => a + b) / successScores.length : 0,
                            failScores.length > 0 ? failScores.reduce((a, b) => a + b) / failScores.length : 0
                        ],
                        backgroundColor: ['rgba(76, 175, 80, 0.7)', 'rgba(244, 67, 54, 0.7)'],
                        borderColor: ['#4caf50', '#f44336'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: 5000
                        }
                    },
                    plugins: {
                        annotation: {
                            annotations: {
                                threshold: {
                                    type: 'line',
                                    yMin: threshold,
                                    yMax: threshold,
                                    borderColor: 'blue',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: `ì„ê³„ê°’: ${threshold}`,
                                        enabled: true,
                                        position: 'start'
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function drawCorrelationChart() {
            // ìƒê´€ê´€ê³„ ê³„ì‚°ì„ ìœ„í•œ ë°ì´í„° ì¤€ë¹„
            const validData = analysisData.merged.filter(d => d.sensor);
            
            if (validData.length > 0) {
                // ê°„ë‹¨í•œ ìƒê´€ê´€ê³„ ì‹œê°í™” (ì‹¤ì œ ìƒê´€ê³„ìˆ˜ ê³„ì‚°ì€ ë³µì¡í•˜ë¯€ë¡œ ì‹œê°ì  í‘œí˜„ë§Œ)
                const ctx = document.getElementById('correlationChart').getContext('2d');
                
                // Face Orientation Score ê³„ì‚°
                validData.forEach(d => {
                    if (d.sensor) {
                        const deviation = Math.sqrt(
                            Math.pow(d.sensor.eulerX, 2) + 
                            Math.pow(d.sensor.eulerY, 2) + 
                            Math.pow(d.sensor.eulerZ, 2)
                        );
                        d.sensor.faceOrientationScore = Math.max(0, 100 - (deviation / 45) * 100);
                    }
                });
                
                // ì„¼ì„œ ë°ì´í„°ì™€ ê²°ê³¼ì˜ ê´€ê³„ í‘œì‹œ
                new Chart(ctx, {
                    type: 'bubble',
                    data: {
                        datasets: [{
                            label: 'ì¡°ë„ vs ì •ë©´ì‘ì‹œì ìˆ˜',
                            data: validData.map(d => ({
                                x: d.sensor.ambientLight,
                                y: d.sensor.faceOrientationScore,
                                r: (d.liveness?.result === 1 && d.matching?.result === 1) ? 8 : 5
                            })),
                            backgroundColor: validData.map(d => 
                                (d.liveness?.result === 1 && d.matching?.result === 1) 
                                    ? 'rgba(76, 175, 80, 0.6)' 
                                    : 'rgba(244, 67, 54, 0.6)'
                            )
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: { display: true, text: 'ì¡°ë„ (lux)' }
                            },
                            y: {
                                title: { display: true, text: 'ì •ë©´ ì‘ì‹œ ì ìˆ˜' },
                                min: 0,
                                max: 100
                            }
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>